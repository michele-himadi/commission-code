---
title: "spaghetti-analysis"
output: html_document
---
```{r, include=FALSE}
# **************************************************************************** #
# ***************                Project Setup                 *************** # 
# **************************************************************************** #

## package installs
# install.packages("readxl")
# install.packages("readr")
install.packages("dplyr")

# library
library(readxl)
library(readr)
library(dplyr)
library(scales)
library(ggplot2)
library(mgcv)
library(cowplot)
library(grid)

```


```{r, include=FALSE}
# **************************************************************************** #
# ***************         Extract and Import Data             **************** #                  
# **************************************************************************** #

# the documents were downloaded from email, so set wd to your personal Downloads folder
# ensure you run the chunk as a whole
setwd("C:/Users/miche/Downloads")

#Hep B data can be read fine as an excel, Hep C data needed to be validated first: uploaded into Google Drive, then exported as .csv

hep_b <- read_excel("Hepatitis B Cases - NCH Deidentified.xlsx")
hep_c <- read_csv("Hep_C.csv")

# write.csv(hep_c, "C:/Users/miche/Downloads/hep_c_export.csv", row.names = FALSE)

hep_b_clean <- hep_b[, -c(3:6,13:20)]
hep_c_clean <- hep_c[, -c(3:6,13:20)]

```

```{r, include=FALSE}
# **************************************************************************** #
# ***************         LFT Format and Spaghetti           **************** #                  
# **************************************************************************** #

#LFT - ALT, AST, Bilirubin

hep_b_lft <- hep_b_clean[, c(9:12, 20:23, 31:34, 42:45, 56:59)]
hep_b_lft$`Date of LFTs 1` <- as.Date(hep_b_lft$`Date of LFTs 1`, format = "%Y-%m-%d")
hep_b_lft$`Date of LFTs 2` <- as.Date(hep_b_lft$`Date of LFTs 2`, format = "%Y-%m-%d")
hep_b_lft$`Date of LFTs 3` <- as.Date(hep_b_lft$`Date of LFTs 3`, format = "%Y-%m-%d")
hep_b_lft$`Date of LFTs 4` <- as.Date(hep_b_lft$`Date of LFTs 4`, format = "%Y-%m-%d")
hep_b_lft$`Date of LFTs 5` <- as.Date(hep_b_lft$`Date of LFTs 5`, format = "%Y-%m-%d")

hep_b_lft$date2 <- as.numeric(hep_b_lft[[8]] - hep_b_lft[[4]])
hep_b_lft$date3 <- as.numeric(hep_b_lft[[12]] - hep_b_lft[[4]])
hep_b_lft$date4 <- as.numeric(hep_b_lft[[16]] - hep_b_lft[[4]])
hep_b_lft$date5 <- as.numeric(hep_b_lft[[20]] - hep_b_lft[[4]])

#age grouping
hep_b_lft <- hep_b_lft %>%
  mutate(
    age_group = case_when(
      `Age in Years` >= 30 & `Age in Years` <= 50 ~ "30–50",
      `Age in Years` >= 70 & `Age in Years` <= 90 ~ "70–90",
      TRUE ~ NA_character_
    )
  )

#making data frame
n <- nrow(hep_b_lft)
plot_data <- data.frame(
  id = rep(1:n, each = 3),
  days = as.vector(t(cbind(
    rep(0, n),         # Day 0 for titer 1
    hep_b_lft$date2,   # Day for titer 2
    hep_b_lft$date3    # Day for titer 3
  ))),
  titer = as.vector(t(cbind(
    hep_b_lft$`Hblft Titer 1`,
    hep_b_lft$`Hblft Titer 2`,
    hep_b_lft$`Hblft Titer 3`
  ))),
  age_group = rep(hep_b_lft$age_group, each = 3)
)



```
