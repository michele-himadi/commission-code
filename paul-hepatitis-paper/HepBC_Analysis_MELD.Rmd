---
title: "spaghetti-analysis"
output: html_document
---
```{r, include=FALSE}
# **************************************************************************** #
# ***************                Project Setup                 *************** # 
# **************************************************************************** #

## package installs
# install.packages("readxl")
# install.packages("readr")
# install.packages("dplyr")

# library
library(readxl)
library(readr)
library(dplyr)
library(scales)
library(ggplot2)
library(mgcv)
library(cowplot)
library(grid)

```


```{r, include=FALSE}
# **************************************************************************** #
# ***************         Extract and Import Data             **************** #                  
# **************************************************************************** #

hep_b <- readxl::read_excel(
  file.path(getwd(), "datasets", "Hepatitis B Cases - NCH Deidentified.xlsx")
)
hep_c <- readxl::read_excel(
  file.path(getwd(), "datasets", "Hepatitis C Cases - NCH Deidentified.xlsx")
)

hep_b_clean <- hep_b[, -c(3:6,13:18)]
hep_c_clean <- hep_c[, -c(3:6,13:18)]
```

```{r, include=FALSE}
# **************************************************************************** #
# ***************       HepB MELD Score Calculations          **************** #                  
# **************************************************************************** #


# MELD 1
hep_b_clean$MELD_NA_1 <- NA
for(i in seq_len(nrow(hep_b_clean))) {
  val_15 <- hep_b_clean[i, 15]
  val_13 <- hep_b_clean[i, 13]
  val_20 <- hep_b_clean[i, 20]
  # Replace blank or NA in val_20 with 1.0
  if (is.na(val_20) || val_20 == "") {
    val_20 <- 1.0
  }
  val_16 <- hep_b_clean[i, 16]
  val_15_clamped <- max(val_15, 1.0)
  val_13_clamped <- max(val_13, 1.0)
  MELD_score_1 <- ((0.957 * log(val_15_clamped)) + (0.378 * log(val_13_clamped)) + (1.12 * log(val_20) + 0.643)) * 10
  val_16_clamped <- min(max(val_16, 125), 137)
  MELD_NA_1 <- MELD_score_1 + 1.32 * (137 - val_16_clamped) - (0.033 * MELD_score_1 * (137 - val_16_clamped))
  hep_b_clean$MELD_NA_1[i] <- MELD_NA_1
}
hep_b_clean$MELD_NA_1 <- as.numeric(hep_b_clean$MELD_NA_1)


# MELD 2
hep_b_clean$MELD_NA_2 <- NA
for(i in seq_len(nrow(hep_b_clean))) {
  val_28 <- hep_b_clean[i, 28]
  val_26 <- hep_b_clean[i, 26]
  val_33 <- hep_b_clean[i, 33]
  # Replace blank or NA in val_33 with 1.0
  if (is.na(val_33) || val_33 == "") {
    val_33 <- 1.0
  }
  val_29 <- hep_b_clean[i, 29]
  val_28_clamped <- max(val_28, 1.0)
  val_26_clamped <- max(val_26, 1.0)
  MELD_score_2 <- ((0.957 * log(val_28_clamped)) + (0.378 * log(val_26_clamped)) + (1.12 * log(val_33) + 0.643)) * 10
  val_29_clamped <- min(max(val_29, 125), 137)
  MELD_NA_2 <- MELD_score_2 + 1.32 * (137 - val_29_clamped) - (0.033 * MELD_score_2 * (137 - val_29_clamped))
  hep_b_clean$MELD_NA_2[i] <- MELD_NA_2
}
hep_b_clean$MELD_NA_2 <- as.numeric(hep_b_clean$MELD_NA_2)


# MELD 3
hep_b_clean$MELD_NA_3 <- NA  # Initialize the new column
for(i in seq_len(nrow(hep_b_clean))) {
  val_41 <- hep_b_clean[i, 41]
  val_39 <- hep_b_clean[i, 39]
  val_46 <- hep_b_clean[i, 46]
  # Replace blank or NA in val_46 with 1.0
  if (is.na(val_46) || val_46 == "") {
    val_46 <- 1.0
  }
    val_42 <- hep_b_clean[i, 42]
  val_41_clamped <- max(val_41, 1.0)
  val_39_clamped <- max(val_39, 1.0)
  MELD_score_3 <- ((0.957 * log(val_41_clamped)) + (0.378 * log(val_39_clamped)) + (1.12 * log(val_46) + 0.643)) * 10
  val_42_clamped <- min(max(val_42, 125), 137)
  MELD_NA_3 <- MELD_score_3 + 1.32 * (137 - val_42_clamped) - (0.033 * MELD_score_3 * (137 - val_42_clamped))
  hep_b_clean$MELD_NA_3[i] <- MELD_NA_3
}
hep_b_clean$MELD_NA_3 <- as.numeric(hep_b_clean$MELD_NA_3)

# MELD 4
hep_b_clean$MELD_NA_4 <- NA  
for(i in seq_len(nrow(hep_b_clean))) {
  val_54 <- hep_b_clean[i, 54]
  val_52 <- hep_b_clean[i, 52]
  val_59 <- hep_b_clean[i, 59]
  # Replace blank or NA in val_59 with 1.0
  if (is.na(val_59) || val_59 == "") {
    val_59 <- 1.0
  }
  val_55 <- hep_b_clean[i, 55]
  val_54_clamped <- max(val_54, 1.0)
  val_52_clamped <- max(val_52, 1.0)
  MELD_score_4 <- ((0.957 * log(val_54_clamped)) + (0.378 * log(val_52_clamped)) + (1.12 * log(val_59) + 0.643)) * 10
  val_55_clamped <- min(max(val_55, 125), 137)
  MELD_NA_4 <- MELD_score_4 + 1.32 * (137 - val_55_clamped) - (0.033 * MELD_score_4 * (137 - val_55_clamped))
  hep_b_clean$MELD_NA_4[i] <- MELD_NA_4
}
hep_b_clean$MELD_NA_4 <- as.numeric(hep_b_clean$MELD_NA_4)

# MELD 5
hep_b_clean$MELD_NA_5 <- NA 
for(i in seq_len(nrow(hep_b_clean))) {
  val_67 <- hep_b_clean[i, 67]
  val_65 <- hep_b_clean[i, 65]
  val_72 <- hep_b_clean[i, 72]
  # Replace blank or NA in val_72 with 1.0
  if (is.na(val_72) || val_72 == "") {
    val_62 <- 1.0
  }
  val_68 <- hep_b_clean[i, 68]
  val_67_clamped <- max(val_67, 1.0)
  val_65_clamped <- max(val_65, 1.0)
  MELD_score_5 <- ((0.957 * log(val_67_clamped)) + 
                   (0.378 * log(val_65_clamped)) + 
                   (1.12 * log(val_72) + 0.643)) * 10
  val_68_clamped <- min(max(val_68, 125), 137)
  MELD_NA_5 <- MELD_score_5 + 1.32 * (137 - val_68_clamped) - (0.033 * MELD_score_5 * (137 - val_68_clamped))
  hep_b_clean$MELD_NA_5[i] <- MELD_NA_5
}
hep_b_clean$MELD_NA_5 <- as.numeric(hep_b_clean$MELD_NA_5)

hep_b_MELDNA <- hep_b_clean[, c(1,2,13,15,16,20,26,28,29,33,39,41,42,46,52,54,55,59,74:78)]
hep_b_MELDNA$MELD_NA_1 <- as.numeric(hep_b_MELDNA$MELD_NA_1)
hep_b_MELDNA$MELD_NA_2 <- as.numeric(hep_b_MELDNA$MELD_NA_2)
hep_b_MELDNA$MELD_NA_3 <- as.numeric(hep_b_MELDNA$MELD_NA_3)
hep_b_MELDNA$MELD_NA_4 <- as.numeric(hep_b_MELDNA$MELD_NA_4)
hep_b_MELDNA$MELD_NA_5 <- as.numeric(hep_b_MELDNA$MELD_NA_5)

write.csv(hep_b_MELDNA, "B_MELD_NA.csv", row.names = FALSE)

```

```{r, include=FALSE}
# **************************************************************************** #
# ***************       HepC MELD Score Calculations          **************** #                  
# **************************************************************************** #


# MELD 1
hep_c_clean$MELD_NA_1 <- NA
for(i in seq_len(nrow(hep_c_clean))) {
  val_15 <- hep_c_clean[i, 15]
  val_13 <- hep_c_clean[i, 13]
  val_20 <- hep_c_clean[i, 20]
  # Replace blank or NA in val_20 with 1.0
  if (is.na(val_20) || val_20 == "") {
    val_20 <- 1.0
  }
  val_16 <- hep_c_clean[i, 16]
  val_15_clamped <- max(val_15, 1.0)
  val_13_clamped <- max(val_13, 1.0)
  MELD_score_1 <- ((0.957 * log(val_15_clamped)) + (0.378 * log(val_13_clamped)) + (1.12 * log(val_20) + 0.643)) * 10
  val_16_clamped <- min(max(val_16, 125), 137)
  MELD_NA_1 <- MELD_score_1 + 1.32 * (137 - val_16_clamped) - (0.033 * MELD_score_1 * (137 - val_16_clamped))
  hep_c_clean$MELD_NA_1[i] <- MELD_NA_1
}
hep_c_clean$MELD_NA_1 <- as.numeric(hep_c_clean$MELD_NA_1)


# MELD 2
hep_c_clean$MELD_NA_2 <- NA
for(i in seq_len(nrow(hep_c_clean))) {
  val_28 <- hep_c_clean[i, 28]
  val_26 <- hep_c_clean[i, 26]
  val_33 <- hep_c_clean[i, 33]
  # Replace blank or NA in val_33 with 1.0
  if (is.na(val_33) || val_33 == "") {
    val_33 <- 1.0
  }
  val_29 <- hep_c_clean[i, 29]
  val_28_clamped <- max(val_28, 1.0)
  val_26_clamped <- max(val_26, 1.0)
  MELD_score_2 <- ((0.957 * log(val_28_clamped)) + (0.378 * log(val_26_clamped)) + (1.12 * log(val_33) + 0.643)) * 10
  val_29_clamped <- min(max(val_29, 125), 137)
  MELD_NA_2 <- MELD_score_2 + 1.32 * (137 - val_29_clamped) - (0.033 * MELD_score_2 * (137 - val_29_clamped))
  hep_c_clean$MELD_NA_2[i] <- MELD_NA_2
}
hep_c_clean$MELD_NA_2 <- as.numeric(hep_c_clean$MELD_NA_2)


# MELD 3
hep_c_clean$MELD_NA_3 <- NA  # Initialize the new column
for(i in seq_len(nrow(hep_c_clean))) {
  val_41 <- hep_c_clean[i, 41]
  val_39 <- hep_c_clean[i, 39]
  val_46 <- hep_c_clean[i, 46]
  # Replace blank or NA in val_46 with 1.0
  if (is.na(val_46) || val_46 == "") {
    val_46 <- 1.0
  }
    val_42 <- hep_c_clean[i, 42]
  val_41_clamped <- max(val_41, 1.0)
  val_39_clamped <- max(val_39, 1.0)
  MELD_score_3 <- ((0.957 * log(val_41_clamped)) + (0.378 * log(val_39_clamped)) + (1.12 * log(val_46) + 0.643)) * 10
  val_42_clamped <- min(max(val_42, 125), 137)
  MELD_NA_3 <- MELD_score_3 + 1.32 * (137 - val_42_clamped) - (0.033 * MELD_score_3 * (137 - val_42_clamped))
  hep_c_clean$MELD_NA_3[i] <- MELD_NA_3
}
hep_c_clean$MELD_NA_3 <- as.numeric(hep_c_clean$MELD_NA_3)

# MELD 4
hep_c_clean$MELD_NA_4 <- NA  
for(i in seq_len(nrow(hep_c_clean))) {
  val_54 <- hep_c_clean[i, 54]
  val_52 <- hep_c_clean[i, 52]
  val_59 <- hep_c_clean[i, 59]
  # Replace blank or NA in val_59 with 1.0
  if (is.na(val_59) || val_59 == "") {
    val_59 <- 1.0
  }
  val_55 <- hep_c_clean[i, 55]
  val_54_clamped <- max(val_54, 1.0)
  val_52_clamped <- max(val_52, 1.0)
  MELD_score_4 <- ((0.957 * log(val_54_clamped)) + (0.378 * log(val_52_clamped)) + (1.12 * log(val_59) + 0.643)) * 10
  val_55_clamped <- min(max(val_55, 125), 137)
  MELD_NA_4 <- MELD_score_4 + 1.32 * (137 - val_55_clamped) - (0.033 * MELD_score_4 * (137 - val_55_clamped))
  hep_c_clean$MELD_NA_4[i] <- MELD_NA_4
}
hep_c_clean$MELD_NA_4 <- as.numeric(hep_c_clean$MELD_NA_4)

# MELD 5
hep_c_clean$MELD_NA_5 <- NA 
for(i in seq_len(nrow(hep_c_clean))) {
  val_67 <- hep_c_clean[i, 67]
  val_65 <- hep_c_clean[i, 65]
  val_72 <- hep_c_clean[i, 72]
  # Replace blank or NA in val_72 with 1.0
  if (is.na(val_72) || val_72 == "") {
    val_62 <- 1.0
  }
  val_68 <- hep_c_clean[i, 68]
  val_67_clamped <- max(val_67, 1.0)
  val_65_clamped <- max(val_65, 1.0)
  MELD_score_5 <- ((0.957 * log(val_67_clamped)) + 
                   (0.378 * log(val_65_clamped)) + 
                   (1.12 * log(val_72) + 0.643)) * 10
  val_68_clamped <- min(max(val_68, 125), 137)
  MELD_NA_5 <- MELD_score_5 + 1.32 * (137 - val_68_clamped) - (0.033 * MELD_score_5 * (137 - val_68_clamped))
  hep_c_clean$MELD_NA_5[i] <- MELD_NA_5
}
hep_c_clean$MELD_NA_5 <- as.numeric(hep_c_clean$MELD_NA_5)

hep_c_MELDNA <- hep_c_clean[, c(1,2,13,15,16,20,26,28,29,33,39,41,42,46,52,54,55,59,74:78)]
hep_c_MELDNA$MELD_NA_1 <- as.numeric(hep_c_MELDNA$MELD_NA_1)
hep_c_MELDNA$MELD_NA_2 <- as.numeric(hep_c_MELDNA$MELD_NA_2)
hep_c_MELDNA$MELD_NA_3 <- as.numeric(hep_c_MELDNA$MELD_NA_3)
hep_c_MELDNA$MELD_NA_4 <- as.numeric(hep_c_MELDNA$MELD_NA_4)
hep_c_MELDNA$MELD_NA_5 <- as.numeric(hep_c_MELDNA$MELD_NA_5)

write.csv(hep_c_MELDNA, "C_MELD_NA.csv", row.names = FALSE)

```